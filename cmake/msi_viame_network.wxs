<?xml version="1.0" encoding="UTF-8"?>
<!--
  VIAME Network Installer Bundle (WiX v5)

  This WiX bundle chains together multiple MSI installers:
  * Core VIAME installation
  * Optional component packages (CUDA, PyTorch, etc.)
  * Optional model data packages (from download_viame_addons.csv)
  * Optional GUI installers (DIVE)

  Build with WiX v5:
    wix build -ext WixToolset.Bal.wixext msi_viame_network.wxs -o viame-installer.exe

  Or using dotnet:
    dotnet tool install -g wix
    wix build -ext WixToolset.Bal.wixext msi_viame_network.wxs

  Dependencies (enforced via After attribute):
    * Core: none (always installed, Vital=yes)
    * CUDA, PyTorch, VIVIA, SEAL, Models, Dev-Headers: require Core
    * Extra-CPP: requires Core and CUDA
    * DIVE: standalone (no dependencies)
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:bal="http://wixtoolset.org/schemas/v4/wxs/bal">

  <!-- Define version variables - update these for each release -->
  <?define VIAMEVersion = "1.0.0" ?>
  <?define VIAMEUpgradeCode = "91A46E15-EE49-4411-9836-583499D9C12F" ?>
  <?define DiveVersion = "1.3.0" ?>

  <Bundle
        Name="VIAME Toolkit"
        Version="$(var.VIAMEVersion)"
        UpgradeCode="$(var.VIAMEUpgradeCode)"
        Manufacturer="Kitware Inc."
        HelpUrl="https://viame.kitware.com/"
        AboutUrl="https://github.com/VIAME/VIAME">

    <BootstrapperApplication>
      <bal:WixStandardBootstrapperApplication
        LicenseUrl="https://raw.githubusercontent.com/VIAME/VIAME/master/LICENSE.txt"
        Theme="hyperlinkLargeLicense"
        ThemeFile="msi_viame_options.xml"
        LogoFile="viame-icon-32px.png" />
    </BootstrapperApplication>

    <Chain>
      <!-- Core VIAME Installation (Required) -->
      <MsiPackage
        Id="VIAME_Core"
        SourceFile="VIAME-Core-$(var.VIAMEVersion)-win64.msi"
        Name="VIAME-Core-$(var.VIAMEVersion)-win64.msi"
        DisplayInternalUI="yes"
        Vital="yes">
      </MsiPackage>

      <!-- CUDA Support (Optional) -->
      <MsiPackage
        Id="VIAME_CUDA"
        SourceFile="VIAME-CUDA-$(var.VIAMEVersion)-win64.msi"
        Name="VIAME-CUDA-$(var.VIAMEVersion)-win64.msi"
        DisplayInternalUI="yes"
        InstallCondition="CUDACheckbox=1"
        After="VIAME_Core">
      </MsiPackage>

      <!-- PyTorch Support (Optional) -->
      <MsiPackage
        Id="VIAME_PyTorch"
        SourceFile="VIAME-PyTorch-$(var.VIAMEVersion)-win64.msi"
        Name="VIAME-PyTorch-$(var.VIAMEVersion)-win64.msi"
        DisplayInternalUI="yes"
        InstallCondition="PyTorchCheckbox=1"
        After="VIAME_CUDA">
      </MsiPackage>

      <!-- Extra C++ Detectors (Optional) -->
      <MsiPackage
        Id="VIAME_ExtraCPP"
        SourceFile="VIAME-Extra-CPP-$(var.VIAMEVersion)-win64.msi"
        Name="VIAME-Extra-CPP-$(var.VIAMEVersion)-win64.msi"
        DisplayInternalUI="yes"
        InstallCondition="ExtraCPPCheckbox=1"
        After="VIAME_PyTorch">
      </MsiPackage>

      <!-- DIVE GUI (Optional) -->
      <MsiPackage
        Id="VIAME_Dive"
        Name="VIAME-Dive-$(var.DiveVersion).msi"
        Compressed="yes"
        DisplayInternalUI="yes"
        DownloadUrl="https://github.com/VIAME/VIAME-Web/releases/download/$(var.DiveVersion)/VIAME-Dive-$(var.DiveVersion).msi"
        DisplayName="Downloading VIAME-Dive Installer"
        InstallCondition="DIVECheckbox=1">
      </MsiPackage>

      <!-- VIVIA Interface (Optional) -->
      <MsiPackage
        Id="VIAME_VIVIA"
        SourceFile="VIAME-VIVIA-$(var.VIAMEVersion)-win64.msi"
        Name="VIAME-VIVIA-$(var.VIAMEVersion)-win64.msi"
        DisplayInternalUI="yes"
        InstallCondition="VIVIACheckbox=1"
        After="VIAME_ExtraCPP">
      </MsiPackage>

      <!-- SEAL Toolkit (Optional) -->
      <MsiPackage
        Id="VIAME_SEAL"
        SourceFile="VIAME-SEAL-$(var.VIAMEVersion)-win64.msi"
        Name="VIAME-SEAL-$(var.VIAMEVersion)-win64.msi"
        DisplayInternalUI="yes"
        InstallCondition="SEALCheckbox=1"
        After="VIAME_VIVIA">
      </MsiPackage>

      <!-- Pre-trained Models (Optional) -->
      <MsiPackage
        Id="VIAME_Models"
        SourceFile="VIAME-Models-$(var.VIAMEVersion)-win64.msi"
        Name="VIAME-Models-$(var.VIAMEVersion)-win64.msi"
        DisplayInternalUI="yes"
        InstallCondition="ModelsCheckbox=1"
        After="VIAME_SEAL">
      </MsiPackage>

      <!-- Development Headers (Optional) -->
      <MsiPackage
        Id="VIAME_DevHeaders"
        SourceFile="VIAME-Dev-Headers-$(var.VIAMEVersion)-win64.msi"
        Name="VIAME-Dev-Headers-$(var.VIAMEVersion)-win64.msi"
        DisplayInternalUI="yes"
        InstallCondition="DevHeadersCheckbox=1"
        After="VIAME_Models">
      </MsiPackage>

      <!-- Additional Model Data Packages (from chain file) -->
      <?include "msi_viame_chain_file.wxs"?>
    </Chain>
  </Bundle>
</Wix>
