# =============================================================================
# Title: Train Tracker - Adaptive
#
# Description: Configuration for training adaptive tracker
# =============================================================================

#  ============================== Adaptive Tracker Trainer ==============================
#
#  This configuration uses the adaptive tracker trainer to analyze tracking data
#  statistics and run appropriate tracker training pipelines.
#
#  Up to 3 trainers will be run sequentially based on:
#  - Hard requirements: minimum tracks, track lengths, fragmentation rates, velocities
#  - Soft preferences: track length (short/medium/long), motion (stationary/slow/fast),
#                      density (sparse/medium/dense), fragmentation, occlusion, appearance
#
#  Statistics computed from training data:
#    - Track counts (total, per-class, short/medium/long distribution)
#    - Track lengths (min, max, mean, median)
#    - Fragmentation (gaps per track, gap lengths, fragmentation rate)
#    - Motion patterns (velocity mean/max/std, direction changes)
#    - Concurrent tracks (mean/max per frame, crowded/sparse frame counts)
#    - Object sizes (for Re-ID crop sizing decisions)
#    - Appearance consistency (within-track size variance)
#    - Occlusion/proximity (close track pairs, potential ID switches)
#
#  Configured trainers:
#    1. ByteTrack - Parameter-based, Kalman filter optimization (10+ tracks)
#    2. OC-SORT   - Extended ByteTrack with direction consistency (10+ tracks)
#    3. DeepSORT  - Re-ID model training for appearance matching (50+ tracks)
#    4. BoT-SORT  - Re-ID + camera motion compensation (50+ tracks)
#    5. SRNN      - Complex multi-stage LSTM for difficult scenarios (100+ tracks)
#
#  ======================================================================================

#  Track reader configuration
track_reader:type = viame_csv

#  Groundtruth file extensions
groundtruth_extensions = .csv

#  Can be either: "one_per_file" or "one_per_folder"
groundtruth_style = one_per_folder

#  Semicolon list of image extensions
image_extensions = .jpg;.jpeg;.JPG;.JPEG;.tif;.tiff;.TIF;.TIFF;.png;.PNG;.bmp;.BMP

#  Semicolon list of video extensions
video_extensions = .mp4;.MP4;.mpg;.MPG;.mpeg;.MPEG;.avi;.AVI;.wmv;.WMV;.mov;.MOV;.webm;.WEBM


# ==============================================================================
#  Algorithm to use for 'tracker_trainer'.
# ==============================================================================
tracker_trainer:type = adaptive

block tracker_trainer:adaptive

  # Maximum number of trainers to run sequentially
  max_trainers_to_run = 3

  # ---- Track length thresholds (frames) ----
  short_track_threshold = 10
  long_track_threshold = 100

  # ---- Motion thresholds (pixels per frame) ----
  stationary_velocity_threshold = 2.0
  fast_velocity_threshold = 50.0

  # ---- Density thresholds (concurrent tracks per frame) ----
  sparse_frame_threshold = 3
  crowded_frame_threshold = 15

  # ---- Object size thresholds (area in pixels^2) ----
  small_object_threshold = 1024
  large_object_threshold = 16384

  # ---- Proximity threshold (pixels) ----
  # Tracks closer than this are considered "close"
  close_distance_threshold = 50.0

  # ---- Appearance variance threshold ----
  # Coefficient of variation above which a track has "high variance"
  high_variance_threshold = 0.3

  # Output statistics to JSON file
  output_statistics_file = tracking_data_statistics.json

  # Enable verbose logging
  verbose = true

endblock


# ==============================================================================
#  Trainer 1: ByteTrack
#  - Parameter-based Kalman filter optimization (no ML training)
#  - Fast, works with few tracks
#  - Best for: Simple motion scenarios, sparse scenes, continuous tracks
# ==============================================================================
block tracker_trainer:adaptive:trainer_1
  # ---- Hard requirements ----
  required_min_tracks = 10
  required_min_track_length = 0
  required_min_mean_track_length = 5.0
  required_max_fragmentation_rate = 0.0
  required_max_velocity = 0.0
  required_max_concurrent_tracks = 0
  required_min_object_area = 0

  # ---- Soft preferences ----
  track_length_preference =
  motion_preference = slow
  density_preference = sparse
  fragmentation_preference = continuous
  occlusion_preference = low
  appearance_preference =
  prefers_reid = false
endblock

tracker_trainer:adaptive:trainer_1:trainer:type = bytetrack

block tracker_trainer:adaptive:trainer_1:trainer:bytetrack
  identifier = adaptive_bytetrack
  train_directory = deep_training
  output_directory = category_models
  output_prefix = bytetrack_tracker
  threshold = 0.00
  min_std_weight_position = 0.01
  max_std_weight_position = 0.5
  min_std_weight_velocity = 0.001
  max_std_weight_velocity = 0.1
endblock


# ==============================================================================
#  Trainer 2: OC-SORT
#  - Extended ByteTrack with velocity direction consistency
#  - Better for objects that change direction
#  - Best for: Moderate motion, some direction changes
# ==============================================================================
block tracker_trainer:adaptive:trainer_2
  # ---- Hard requirements ----
  required_min_tracks = 10
  required_min_track_length = 0
  required_min_mean_track_length = 5.0
  required_max_fragmentation_rate = 0.0
  required_max_velocity = 0.0
  required_max_concurrent_tracks = 0
  required_min_object_area = 0

  # ---- Soft preferences ----
  track_length_preference = medium
  motion_preference =
  density_preference = medium
  fragmentation_preference =
  occlusion_preference = low
  appearance_preference =
  prefers_reid = false
endblock

tracker_trainer:adaptive:trainer_2:trainer:type = ocsort

block tracker_trainer:adaptive:trainer_2:trainer:ocsort
  identifier = adaptive_ocsort
  train_directory = deep_training
  output_directory = category_models
  output_prefix = ocsort_tracker
  threshold = 0.00
  min_std_weight_position = 0.01
  max_std_weight_position = 0.5
  min_std_weight_velocity = 0.001
  max_std_weight_velocity = 0.1
endblock


# ==============================================================================
#  Trainer 3: DeepSORT
#  - Re-ID model training for appearance-based matching
#  - Requires larger objects for good crop features
#  - Best for: Dense scenes, occlusion recovery, appearance distinguishes objects
# ==============================================================================
block tracker_trainer:adaptive:trainer_3
  # ---- Hard requirements ----
  required_min_tracks = 50
  required_min_track_length = 0
  required_min_mean_track_length = 10.0
  required_max_fragmentation_rate = 0.0
  required_max_velocity = 0.0
  required_max_concurrent_tracks = 0
  required_min_object_area = 2048

  # ---- Soft preferences ----
  track_length_preference = long
  motion_preference =
  density_preference = dense
  fragmentation_preference =
  occlusion_preference = high
  appearance_preference = consistent
  prefers_reid = true
endblock

tracker_trainer:adaptive:trainer_3:trainer:type = deepsort

block tracker_trainer:adaptive:trainer_3:trainer:deepsort
  identifier = adaptive_deepsort
  train_directory = deep_training
  output_directory = category_models
  output_prefix = deepsort_tracker
  gpu_count = -1
  max_epochs = 50
  batch_size = 32
  learning_rate = 0.0003
  threshold = 0.00
  timeout = 604800
  crop_size = 128x64
  embedding_dim = 512
  backbone = resnet18
endblock


# ==============================================================================
#  Trainer 4: BoT-SORT
#  - Re-ID + camera motion compensation
#  - Best for moving cameras (ROVs, drones, handheld)
#  - Good for: Fast motion, camera shake, appearance matching
# ==============================================================================
block tracker_trainer:adaptive:trainer_4
  # ---- Hard requirements ----
  required_min_tracks = 50
  required_min_track_length = 0
  required_min_mean_track_length = 10.0
  required_max_fragmentation_rate = 0.0
  required_max_velocity = 0.0
  required_max_concurrent_tracks = 0
  required_min_object_area = 2048

  # ---- Soft preferences ----
  track_length_preference = medium
  motion_preference = fast
  density_preference = medium
  fragmentation_preference =
  occlusion_preference = medium
  appearance_preference =
  prefers_reid = true
endblock

tracker_trainer:adaptive:trainer_4:trainer:type = botsort

block tracker_trainer:adaptive:trainer_4:trainer:botsort
  identifier = adaptive_botsort
  train_directory = deep_training
  output_directory = category_models
  output_prefix = botsort_tracker
  gpu_count = -1
  max_epochs = 50
  batch_size = 32
  learning_rate = 0.0003
  threshold = 0.00
  timeout = 604800
  crop_size = 128x64
  embedding_dim = 512
  backbone = resnet18
  feat_ema_alpha = 0.9
  use_cmc = true
  use_reid = true
endblock


# ==============================================================================
#  Trainer 5: SRNN (Siamese RNN)
#  - Complex multi-stage LSTM-based tracking
#  - Needs substantial data for training
#  - Best for: Complex scenarios, many concurrent tracks, interaction modeling
# ==============================================================================
block tracker_trainer:adaptive:trainer_5
  # ---- Hard requirements ----
  required_min_tracks = 100
  required_min_track_length = 0
  required_min_mean_track_length = 20.0
  required_max_fragmentation_rate = 0.0
  required_max_velocity = 0.0
  required_max_concurrent_tracks = 0
  required_min_object_area = 1024

  # ---- Soft preferences ----
  track_length_preference = long
  motion_preference =
  density_preference = dense
  fragmentation_preference = fragmented
  occlusion_preference = high
  appearance_preference = varying
  prefers_reid = true
endblock

tracker_trainer:adaptive:trainer_5:trainer:type = srnn

block tracker_trainer:adaptive:trainer_5:trainer:srnn
  identifier = adaptive_srnn
  train_directory = deep_training
  output_directory = category_models
  output_prefix = srnn_tracker
  gpu_count = -1
  threshold = 0.00
  timeout = 604800
  stabilized = false
  grid_num = 15
  siamese_img_sample_rate = 8
  siamese_pos_sample_rate = 10
  rnn_component = AIM
endblock
