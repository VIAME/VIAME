# =============================================================================
# Title: Train Detector - LITDET Ssd
#
# Description: Configuration for training object detector. Input resolution:
# 300px.
# =============================================================================

include common_train_detector.conf

#  Pipeline template file.
relativepath pipeline_template = templates/embedded_default.pipe

#  Augmentation pipeline.
#relativepath augmentation_pipeline = train_aug_hue_shifting_only.pipe

#  Augmentatation cache.
augmentation_cache = augmented_images

#  Do not regenerate cache.
regenerate_cache = true


#  Algorithm to use for 'detector_trainer'.
detector_trainer:type = ocv_windowed

block detector_trainer:ocv_windowed

  # Directory for all files used in training
  train_directory = deep_training

  # Windowing mode, can be disabled, maintain_ar, scale, chip, adaptive
  mode = original_and_resized

  # Resized chip width (SSD300 default is 300).
  chip_width = 300

  # Resized chip height (SSD300 default is 300).
  chip_height = 300

  # Adaptive size threshold for chipping
  chip_adaptive_thresh = 1600000

  # Don't train on chips with detections smaller than this
  min_train_box_length = 5

  # Uncomment to remove small detections instead of training on them
  #small_box_area = 290
  #small_action = remove

  # Image reader type
  image_reader:type = vxl

endblock

block detector_trainer:ocv_windowed:trainer

  # Trainer type
  type = litdet

  # Model architecture type (faster_rcnn, ssd, ssdlite, retinanet, fcos)
  # ssd = SSD300 with VGG16 backbone
  # ssdlite = SSDLite320 with MobileNetV3 backbone (faster, lighter)
  litdet:model_type = ssd

  # Backbone architecture (vgg16 for SSD300)
  litdet:backbone = vgg16

  # Device to train on (auto, cpu, cuda, cuda:N)
  litdet:device = auto

  # Fine-tuning: use pretrained weights (true/false)
  litdet:fine_tune = true

  # Pretrained weights source: coco, imagenet, none, or path to weights file
  litdet:pretrained_weights = coco

  # Network perspective field size
  litdet:chip_width = 300

  # Path to seed model for continuing training
  litdet:seed_model =

  # Image train batch size (SSD can handle larger batches)
  litdet:batch_size = 8

  # Maximum training epochs
  litdet:max_epochs = 100

  # Training learning rate
  litdet:learning_rate = 1e-3

  # Weight decay for optimizer
  litdet:weight_decay = 5e-4

  # Number of trainable backbone layers (0-5)
  litdet:trainable_backbone_layers = 3

  # Save top k checkpoints
  litdet:save_top_k = 1

  # Enable TensorBoard logging
  litdet:use_tensorboard = true

  # Run test evaluation after training
  litdet:run_test = true

endblock
