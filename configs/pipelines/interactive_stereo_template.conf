# =============================================================================
# Title: Interactive Stereo Service Configuration - Template Matching / OpenCV
#
# Description: KWIVER flat config for the interactive stereo annotation service.
# Used by python -m viame.core.interactive_stereo for interactive disparity
# computation in DIVE stereo annotation mode.
#
# This configuration uses OpenCV Block Matching (BM), a template matching
# approach that slides a window across the epipolar line to find the best
# match using Sum of Absolute Differences (SAD). It is fast and does not
# require GPU or neural network inference.
#
# If BM produces poor results for your data (e.g. textureless regions or
# repetitive patterns), switch to SGBM by changing the algorithm parameter
# below. SGBM adds semi-global optimization for smoother disparity maps
# at the cost of additional processing time.
# =============================================================================

compute_stereo_depth_map:type = ocv_stereo_disparity

# ---------------------------------------------------------------------------
# Primary: Block Matching (BM) - template matching along epipolar lines
# ---------------------------------------------------------------------------
compute_stereo_depth_map:ocv_stereo_disparity:algorithm = BM

# Minimum possible disparity value. Normally 0, but can be negative for
# cameras with convergent optical axes.
compute_stereo_depth_map:ocv_stereo_disparity:min_disparity = 0

# Maximum disparity minus minimum disparity. Must be divisible by 16.
# Larger values allow matching objects closer to the camera.
compute_stereo_depth_map:ocv_stereo_disparity:num_disparities = 128

# SAD window size for BM. Must be odd, typically 5-21.
# Larger windows are more robust to noise but blur edges.
compute_stereo_depth_map:ocv_stereo_disparity:sad_window_size = 15

# Speckle filtering - removes small isolated disparity regions
compute_stereo_depth_map:ocv_stereo_disparity:speckle_window_size = 100
compute_stereo_depth_map:ocv_stereo_disparity:speckle_range = 32

# Output format: "uint16_scaled" produces disparity * 256 as uint16
compute_stereo_depth_map:ocv_stereo_disparity:output_format = uint16_scaled

# WLS filtering - smooths disparity while preserving edges
compute_stereo_depth_map:ocv_stereo_disparity:use_wls_filter = true
compute_stereo_depth_map:ocv_stereo_disparity:wls_lambda = 8000.0
compute_stereo_depth_map:ocv_stereo_disparity:wls_sigma = 1.5

# ---------------------------------------------------------------------------
# Fallback: Semi-Global Block Matching (SGBM)
#
# To use SGBM instead of BM, uncomment the lines below and comment out
# the BM algorithm line above.
# ---------------------------------------------------------------------------
# compute_stereo_depth_map:ocv_stereo_disparity:algorithm = SGBM
# compute_stereo_depth_map:ocv_stereo_disparity:block_size = 5

# Service settings
service:scale = 1.0
